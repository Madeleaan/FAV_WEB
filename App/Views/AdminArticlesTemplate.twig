{% if (logged is not null) and(logged.role.value >= enum('App\\Models\\Role').ADMIN.value) %}
<ul class="list-group gap-3">
    {% for article in articles %}
    {% set editors = (allEditors.(article.id) is defined) ? allEditors.(article.id) : [] %}
    {% set reviews = (allReviews.(article.id) is defined) ? allReviews.(article.id) : [] %}
    {% set completed = (allReviews.(article.id) is defined) ? (reviews | filter(r => r.quality != -1)) : [] %}
    <div class="card" data-article="{{ article.id }}">
        <div class="card-body">
            {% switch article.status %}
            {% case 'waiting' %}
            <span class="badge text-bg-info">Čeká na hodnocení</span>
            {% case 'accepted' %}
            <span class="badge text-bg-success">Akceptovaný</span>
            {% case 'denied' %}
            <span class="badge text-bg-danger">Zamítnutý</span>
            {% default %}
            <span class="badge text-bg-secondary">Neznámý status</span>
            {% endswitch %}

            <div class="row">
                <div class="col-lg-9">
                    <h5 class="card-title text-decoration-underline my-2">{{ article.title }}</h5>
                    <h6 class="card-subtitle mb-2 text-body-secondary">
                        <i class="fas fa-calendar-days"></i> {{ article.date | date('d. m. Y') }}
                    </h6>
                </div>
                <div class="btn-group col-lg-3 my-auto justify-content-end">
                    {% set disabled = (completed | length < 3) ? 'disabled' %}

                    <button class="btn btn-outline-success acceptArticle flex-lg-grow-0" {{ disabled }}>
                    <i class="fa-solid fa-square-check me-1"></i>Akceptovat
                    </button>
                    <button class="btn btn-outline-danger ms-1 denyArticle flex-lg-grow-0" {{ disabled }}>
                    <i class="fa-solid fa-square-xmark me-1"></i>Zamítnout
                    </button>
                </div>
            </div>

            <div class="card-text col-lg-6 my-2">
                {% if (editors is iterable) and (editors | length > 0) %}
                <div class="input-group">
                    <label class="input-group-text" for="selectEditor">Přidání editora</label>
                    <select class="form-select" id="selectEditor">
                        {% for editor in editors %}
                        <option value="{{ editor.id }}">{{ editor.name }}</option>
                        {% endfor %}
                    </select>
                    <button type="button" class="btn btn-success addEditor">Přidat</button>
                </div>
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-striped table-bordered mt-2">
                        <thead>
                        <tr class="align-middle">
                            <th scope="col">Editor</th>
                            <th scope="col">Kvalita</th>
                            <th scope="col">Jazyk</th>
                            <th scope="col">Relevance</th>
                            <th scope="col"></th>
                        </tr>
                        </thead>

                        <tbody>
                        {% if reviews is iterable %}
                        {% for review in reviews %}
                        <tr class="align-middle">
                            <th scope="row" data-id="{{ review.id }}" class="text-nowrap">
                                {{ review.editor.name }}
                            </th>

                            {% if review.quality == -1 %}
                            <td colspan="3"><span class="badge text-bg-secondary">Čeká se na recenzi</span></td>
                            {% else %}
                            <td class="stars text-nowrap">{{ review.quality }}</td>
                            <td class="stars text-nowrap">{{ review.language }}</td>
                            <td class="stars text-nowrap">{{ review.relevancy }}</td>

                            {% endif %}

                            <td>
                                <button class="btn btn-sm btn-outline-danger deleteReview"><i class="fas fa-square-xmark"></i></button>
                            </td>
                        </tr>
                        {% endfor %}
                        {% endif %}

                        {% if reviews | length < 3 %}
                        <td colspan="5"><div class="alert alert-warning mb-0">
                                Nízký počet recenzí, přidejte ještě {{ 3 - (reviews | length) }}
                            </div></td>
                        {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endfor %}
</ul>
{% else %}
<div class="alert alert-danger" role="alert">Obsah pouze pro administrátory</div>
{% endif %}

<script>
    $('.addEditor').on('click', (e) => {
        const article = $(e.target).closest('.card[data-article]')
        const editor = $(e.target).siblings('select')

        $.post({
            url: '/api/admin.php',
            data: JSON.stringify({
                'task': 'add-editor',
                'article': article.attr('data-article'),
                'editor': editor.val()
            }),
            contentType: 'application/json',
            success: () => location.reload()
        })
    })

    $('.deleteReview').on('click', (e) => {
        const review = $(e.target).closest('tr').find('th')

        $.post({
            url: '/api/admin.php',
            data: JSON.stringify({
                'task': 'delete-review',
                'id': review.attr('data-id')
            }),
            contentType: 'application/json',
            success: () => location.reload()
        })
    })

    $('.acceptArticle').on('click', (e) => {
        const article = $(e.target.closest('.card'))

        $.post({
            url: '/api/admin.php',
            data: JSON.stringify({
                'task': 'accept-article',
                'id': article.attr('data-article'),
                'accept': 'true'
            }),
            contentType: 'application/json',
            success: () => location.reload()
        })
    })

    $('.denyArticle').on('click', (e) => {
        const article = $(e.target.closest('.card'))

        $.post({
            url: '/api/admin.php',
            data: JSON.stringify({
                'task': 'accept-article',
                'id': article.attr('data-article'),
                'accept': 'false'
            }),
            contentType: 'application/json',
            success: () => location.reload()
        })
    })

    $('.stars').each((_, el) => {
        const rating = Number(el.textContent);

        const full = new Array(Math.floor(rating + 1)).join('<i class="fas fa-star"></i>')
        const half = ((rating % 1) !== 0) ? '<i class="fas fa-star-half-stroke"></i>' : ''
        const empty = new Array(Math.floor(6 - rating)).join('<i class="far fa-star"></i>')

        el.innerHTML = full + half + empty
    })
</script>